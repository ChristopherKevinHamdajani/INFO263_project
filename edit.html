<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>
    <script type="text/javascript" src="javascript.js"></script>

    <title>Title</title>

</head>
<body>
<div id="page"  class="container-lg">
    <div class="jumbotron text-center">
        <h1>Event Scheduler</h1>
    </div>
    <nav id="navbar" class="navbar navbar-expand-sm bg-dark navbar-dark">
        <a class="navbar-brand" href="#">Navbar</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="collapsibleNavbar">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link " href="mainscreen.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="newEvent.html">New task</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Profile</a>
                </li>
            </ul>
        </div>
    </nav>


    <div id="container" class="container">
        <div id="eventActions">

        </div>
        <script>
            function populateClusterOptions(select, clusterId){
                let command = {'command': "getEventClusterList"}
                $.post('server.php', command, function (data){
                    let obj = JSON.parse(data);
                    for (let i = 0; i < obj.length; i++){
                        if (obj[i]["cluster_id"] === clusterId){
                            $("#" + select).append("<option value=" + obj[i]["cluster_id"] + " selected>" +obj[i]["cluster_name"] + "</option>")
                        } else {
                            $("#" + select).append("<option value=" + obj[i]["cluster_id"] + ">" +obj[i]["cluster_name"] + "</option>")
                        }
                    }

                })
            }


            function createEventActionsEdit(i,actionId, eventId, timeOffset, clusterId, activate){
                let eventActionsDiv =
                    "<div class='container border border-primary'><form id='formActionId"+ actionId +"'class='formActionChange'>" +
                        "<div class='row'><p class='col-6'>Action Id:"+ actionId + "</p><p class='col-6'>Event Id:"+eventId+"</p></div>" +
                        "<div class='row'><label class='col-1'>Time Offset</label><input name='timeOffset' class='col-5' id='timeOffset"+ i +"'>"+timeOffset+"</input></div>" +
                        "<div class='row'><select name='clusterSelect' class='col-6' id=selector" + actionId + "></select><p class='col-6'>"+activate+"</p></div>" +
                        "<div class='row'><button type='submit' for='formActionId"+ actionId+"' id="+ actionId +" class='btn btn-primary actionIdChangeButton'>Change</button><input type='hidden' value='"+actionId+"' name='actionId'></div>" +
                    "</form></div>"
                return eventActionsDiv;
            }
            let command = {'command' :'getEventActions', 'event_id' : 259};
            $.post('server.php', command, function(data){
                let obj = JSON.parse(data)
                let i = 0;
                obj.forEach(function(object){
                    let actionId = object["action_id"];
                    let eventId = object["event_id"];
                    let timeOffset = object["time_offset"];
                    let clusterId = object["cluster_id"];
                    let activate = object["activate"];
                    $("#container").append(createEventActionsEdit(i, actionId, eventId, timeOffset, clusterId, activate));
                    $("#timeOffset" + i).val(timeOffset)
                    populateClusterOptions("selector" + actionId, clusterId)

                    i += 1;
                })

            })

            $(document).on("submit", ".formActionChange", null, function(event){
                let array = $(this).serializeArray()
                console.log(array)
                let timeOffset = array[0].value
                let clusterId = array[1].value
                let actionId = array[2].value

                event.preventDefault()
                let command = {'command' :'updateEventAction', 'action_id' : actionId, 'cluster_id': clusterId, 'time_offset': timeOffset};
                $.post('server.php', command, function(data) {
                    console.log("Worked")
                    window.location.replace("edit.html");
                    alert("Event updated succesfully.")
                })

            })

            let queryString = window.location.search;
            let urlParams = new URLSearchParams(queryString);
            let date = urlParams.get('date');
            let eventId = urlParams.get('eventId');

            console.log(date)
            console.log(eventId)

        </script>

    </div>
</div>



</body>

</html>



























